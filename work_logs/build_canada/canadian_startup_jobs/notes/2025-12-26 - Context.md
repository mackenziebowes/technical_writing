# CONTEXT.md

## Session 2025-12-26

### Frontend-Backend Integration Complete

#### Backend Changes (`apps/server/`)

**Modified:**
- `src/db/functions/queues/index.ts` - Added agent-based priority ordering with SQL CASE:
  ```typescript
  orderBy(sql`CASE
    WHEN ${queues.agent} = 'jobAgent' THEN 1
    WHEN ${queues.agent} = 'jobBoardAgent' THEN 2
    ...
  END`, asc(queues.createdAt))
  ```

- `src/db/functions/jobs/jobs.ts` - Added:
  - `getJobById(id)` - Basic single job fetch
  - `getJobWithRichData(id)` - Returns job + organization + tags in nested structure
  - `listJobs(skip, take)` - Lists jobs with pagination, ordered by createdAt desc

- `src/routes/jobs/jobs.ts` - Added GET routes:
  - `GET /` - Returns listJobs result
  - `GET /:id` - Returns getJobWithRichData result
  - Uses shared `idSchema` for validation

- `src/routes/organizations/index.ts` - Added `GET /:id` route
- `src/routes/sources/index.ts` - Added `GET /:id` route
- `src/index.ts` - Registered new routes: `/jobs`, `/organizations`, `/sources` and CORS config

**Created:**
- `src/workers/runWorker.ts` - Worker module with:
  - `runWorker(config)` - Starts worker with config
  - `resetStuckJobs()` - Resets in_progress jobs to queued
- `src/scripts/runWorker.ts` - Script wrapper calling worker
- `src/db/functions/organizations/organizations.ts` - `getOrganizationById()`
- `src/db/functions/organizations/index.ts` - Export
- `src/db/functions/sources/sources.ts` - `getSourceById()`
- `src/db/functions/sources/index.ts` - Export
- `src/db/types/types.ts` - Shared `idSchema` for DRY + performance

#### Frontend Changes (`apps/web/`)

**Created:**
- `src/utils/config.ts` - API base URL configuration (uses `NEXT_PUBLIC_API_URL` env var)
- `src/data/api/jobs.ts` - API client with:
  - Types: `Job`, `JobWithRichData`
  - Functions: `list()`, `getById(id)`, `getRichById(id)`

**Modified:**
- `src/components/jobs/jobsProvider.tsx` - Converted from static JSON to API:
  - Added `isLoading` state
  - Added `useEffect` to fetch jobs on mount
  - Added `mapApiJobToFrontend()` helper
  - Removed static job imports
  - Fixed references to undefined `jobIdsStatic`/`jobsByIdStatic` variables

**Environment:**
- `apps/web/.env.local` - Created with `NEXT_PUBLIC_API_URL` pointing to backend

#### Architecture Decisions

- **Priority Order**: jobAgent → jobBoardAgent → organizationAgent → portfolioLinksAgent → sourceAgent (pragmatist approach - focus on end data)
- **Schema Caching**: Module-level `idSchema` exported from single file for memory efficiency
- **Rich Data Pattern**: Single `getJobWithRichData()` function fetches all related data (org + tags) in parallel queries using Promise.all. Returns nested structure with job data + organization + tags object.
- **List vs Detail**: List route returns basic job records only. Detail route returns rich data. This separates concerns - list is fast, detail is comprehensive.
- **CORS Config**: Backend CORS middleware configured to allow requests from both localhost:3001 and localhost:3000

#### Technical Issues Resolved

1. **Port Conflicts**: Both frontend and backend were trying to use port 3000. Resolved by:
   - Frontend runs on port 3001 (via `bun run dev -p 3001`)
   - Backend runs on port 3000 (via `bun run dev`)

2. **CORS Error**: Frontend was hardcoded to wrong port (3050) in `src/utils/config.ts`. Fixed:
   - Changed default from 3050 to 3000
   - Backend CORS configured for both ports

3. **JobsProvider Bugs**: References to undefined `jobIdsStatic` and `jobsByIdStatic` variables causing runtime errors. Fixed by using actual state variables `jobIds` and `jobsById`.

### Current Known Issues

- Frontend `jobsList` component is monolithic and mixes concerns (responsive sizing, job mapping, display logic). Needs refactoring into atomic components.
- Frontend codebase lacks documentation for data flow patterns
- Tag fields in frontend Jobs type are not being populated (jobType, experience, industry, role are all undefined)

### Next Tasks

1. Document frontend architecture and component structure
2. Consider refactoring jobsList into smaller, atomic components
3. Tag integration: map API tag data to frontend Job type fields
4. Rich results endpoints (Task 2.2):
   - Implement `getOrganizationWithJobs(id)` - organizations → jobs via orgsJobs pivot
   - Implement `getSourceWithOrganizations(id)` - sources → portfolioCaches → organizations
