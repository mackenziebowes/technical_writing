The following markdown was created, and developed over time, by GLM 4.7 via Charm's Crush to track context between "agent wipes", or manually clearing and refreshing Crush.


# CONTEXT: LLM Agent System & Source Agent Implementation

## Session Date
2025-12-24

## Background

This session resumed work from a previous session (documented in `work-journal/2025-12-23.md`) where a queued LLM agent system was designed with `llm-queues` and `llm-calls` database tables but the worker to process them had not been implemented. The previous session completed:

1. Database helpers types export (`apps/server/src/db/functions/queues/index.ts`, `apps/server/src/db/functions/calls/index.ts`)
2. Shared agent types (`apps/server/src/lib/ai/agents/helpers/types.ts`)
3. Agent registry (`apps/server/src/lib/ai/agents/dictionary.ts`)
4. LLM Call Worker (`apps/server/src/workers/llmCallWorker.ts`)
5. Comprehensive tests (`apps/server/tests/llmCallWorker.test.ts`)
6. Documentation (`apps/server/src/workers/llmCallWorker.md`)
7. Initial Source Agent implementation (`apps/server/src/lib/ai/agents/major/sourceAgent.ts`)

## Work Completed in This Session

### 1. Clarified `usage` Field Purpose

The user clarified that the `usage` field in `AgentResult` should track AI SDK token usage data (input, thinking, output tokens) from LLM responses for cost modeling purposes, NOT custom counters like "firecrawlCalls" or "dbInserts".

The `llm-calls` database table's `usage` column is a JSONB array that can contain mixed data - each item represents the usage result of any API call.

### 2. Updated Source Agent Implementation

**File:** `apps/server/src/lib/ai/agents/major/sourceAgent.ts`

**Changes:**

1. Modified `createNewSourceFromMarkdown` to accept a `usage: unknown[]` parameter
2. Added logic to push AI SDK usage data to the usage array:
   ```typescript
   if (objectData.usage) {
     usage.push(objectData.usage);
   }
   ```
3. Changed `usage` in the main `sourceAgent` function from an object with counters to `unknown[]`:
   ```typescript
   const usage: unknown[] = [];
   ```
4. Removed all counter incrementers (`firecrawlCalls++`, `pagesScraped++`, `aiCalls++`, `dbInserts++`)

The sourceAgent now:
- Fetches home and portfolio pages via Firecrawl
- Creates a source by calling `generateObject()` with Gemini 2.5 Flash to extract source data from home markdown
- Creates a portfolio cache by fetching portfolio URL and computing SHA256 hash with 7-day freshTil
- Connects source to portfolio cache via pivot table `sourcesPortfolioCaches`
- Returns token usage data in the `usage` array

### 3. Created Source Agent Documentation

**File:** `apps/server/src/lib/ai/agents/major/sourceAgent.md`

Comprehensive documentation covering:
- Overview and workflow (3 steps: fetch, extract, create/cache)
- Input schema (payload with `home` and `portfolio` URLs)
- Output structure (`AgentResult` with `usage`, `logs`, `result`, `errors`)
- Dependencies (Firecrawl, AI SDK, Drizzle, Bun SHA256, Zod)
- Usage tracking (how LLM token usage is captured and stored)
- Error handling with `AppError` codes
- Enqueuing example
- Registration in agent dictionary
- Example execution log
- Related files

### 4. Tests Not Updated

Tests were initially attempted to be fixed but the user indicated tests are not important right now, so the test file was left in a broken state.

## Work Completed in This Session (Part 2)

### 5. Created Organization Agent

**File:** `apps/server/src/lib/ai/agents/major/organizationAgent.ts`

The organizationAgent extracts and creates organization records from a company website URL:

**Features:**
- Fetches homepage data via Firecrawl
- Uses `generateText()` with AI tools (`readPage`, `searchSite`) to explore the site
- Uses `generateObject()` with Gemini 2.5 Pro to extract structured organization data
- Inserts organization into the `organizations` table
- **Supports optional pre-fetched data** with freshness checking (24h TTL)
- Tracks token usage in `unknown[]` array
- Returns comprehensive `AgentResult` with logs, usage, result, and errors

**Payload Schema:**
```typescript
{
  url: string;
  preFetchedData?: {
    url: string;
    markdown: string;
    links: string[];
    pulledAt: number;
    freshTil: number;
  };
}
```

### 6. Created Portfolio Links Agent

**File:** `apps/server/src/lib/ai/agents/major/portfolioLinksAgent.ts`

The portfolioLinksAgent filters portfolio links and queues organization discovery:

**Features:**
- Evaluates portfolio links for Canadian headquarters and active status
- Uses `generateObject()` with Gemini 2.5 Flash for efficient batch filtering
- Pre-fetches homepage data (markdown + links) for qualifying companies
- Queues `organizationAgent` jobs with pre-fetched data via `childQueueItems`
- Tracks filtering statistics (qualified vs. filtered out counts)
- Returns comprehensive `AgentResult` with filtering metrics
- Handles individual pre-fetch failures gracefully

**Payload Schema:**
```typescript
{
  sourceId: number;
  links: string[];
}
```

**Pre-Fetched Data TTL:** 24 hours - organizationAgent re-scrapes if data is stale

### 7. Updated Source Agent for Child Task Enqueuing

**File:** `apps/server/src/lib/ai/agents/major/sourceAgent.ts`

**Changes:**
- Added `childQueueItems` array to collect child tasks
- After creating source and portfolio cache, queues a `portfolioLinksAgent` job
- Passes `sourceId` and portfolio `links` to portfolioLinksAgent
- Returns `childQueueItems` in `AgentResult` for the worker to process

**Workflow:**
```
sourceAgent
  └─> portfolioLinksAgent (filters portfolio links)
       └─> organizationAgent × N (for qualifying Canadian companies)
```

### 8. Fixed Import Paths

Updated all imports from `@/functions/*` to `@/db/functions/*` across the codebase:

**Files Updated:**
- `apps/server/src/lib/ai/tools/db/organizations.ts`
- `apps/server/src/routes/tags/*.ts` (8 files)
- `apps/server/src/routes/jobs/jobs.ts`
- `apps/server/src/scripts/createTagFunctions.ts`
- `apps/server/src/scripts/createJobPivotFunctions.ts`
- `apps/server/src/scripts/createOrgPivotFunctions.ts`
- `apps/server/src/db/functions/generators/createTagRoutes.ts`

### 9. Updated Agent Registry

**File:** `apps/server/src/lib/ai/agents/dictionary.ts`

**Changes:**
- Added `organizationAgent` to `agentNamesSchema`
- Added `portfolioLinksAgent` to `agentNamesSchema`
- Registered both agents in `getAgent()` switch statement

### 10. Created Documentation

**New Documentation Files:**
- `apps/server/src/lib/ai/agents/major/organizationAgent.md` - Organization agent docs
- `apps/server/src/lib/ai/agents/major/portfolioLinksAgent.md` - Portfolio links agent docs

**Updated Documentation:**
- `apps/server/src/lib/ai/agents/major/organizationAgent.md` - Added pre-fetched data section, workflow integration, and updated examples

## Work Completed in This Session (Part 3)

### 11. Created Job Agent

**File:** `apps/server/src/lib/ai/agents/major/jobAgent.ts`

The jobAgent extracts and creates job records from an individual job posting URL:

**Features:**
- Fetches job posting data via Firecrawl
- Uses `generateText()` with AI tools (`readPage`, `searchSite`) to explore job posting
- Uses `generateObject()` with Gemini 2.5 Pro to extract structured job data
- Inserts job into the `jobs` table with company name and URLs
- Connects job to organization via `orgsJobs` pivot table
- Creates job cache with SHA256 hash (7-day freshness) via `jobsJobsCaches` pivot
- Tags job using `jobTaggingAgent` (experience levels, industries, job types, roles, provinces)
- **Supports optional pre-fetched data** with freshness checking (7-day TTL)
- Tracks token usage in `unknown[]` array
- Returns comprehensive `AgentResult` with logs, usage, result, and errors

**Payload Schema:**
```typescript
{
  organizationId: number;
  url: string;  // Job posting URL
  companyName: string;
  preFetchedData?: {
    url: string;
    markdown: string;
    links: string[];
    pulledAt: number;
    freshTil: number;
  };
}
```

**Pre-Fetched Data TTL:** 7 days - jobAgent re-scrapes if data is stale

### 12. Updated Prompts Registry

**File:** `apps/server/src/lib/ai/prompts/index.ts`

Added `discoverNewJob` prompt export for job agent usage.

### 13. Updated Agent Registry

**File:** `apps/server/src/lib/ai/agents/dictionary.ts`

**Changes:**
- Added `jobAgent` to `agentNamesSchema`
- Registered agent in `getAgent()` switch statement
- Fixed all `PayloadArgs` exports to use `export type` for verbatimModuleSyntax compatibility

### 14. Created Job Agent Documentation

**File:** `apps/server/src/lib/ai/agents/major/jobAgent.md`

Comprehensive documentation covering:
- Overview and workflow (8 steps: fetch, discover, extract, create, connect, cache, connect, tag)
- Input schema (payload with `organizationId`, `url`, `companyName`, and optional `preFetchedData`)
- Output structure (`AgentResult` with job details, tagging info)
- Dependencies (Firecrawl, AI SDK, Drizzle, Bun SHA256, Zod, jobTaggingAgent)
- Usage tracking (AI SDK usage from exploration, extraction, and tagging)
- Error handling with `AppError` codes
- Enqueuing example
- Pre-fetched data usage pattern
- Registration in agent dictionary
- Example execution log
- Related files

### 15. Created Job Board Agent

**File:** `apps/server/src/lib/ai/agents/major/jobBoardAgent.ts`

The jobBoardAgent discovers job postings on an organization's careers page:

**Features:**
- Fetches careers page via Firecrawl
- Uses `generateObject()` with Gemini 2.5 Flash to identify individual job posting URLs
- Filters job links (identifies actual job postings vs. generic pages)
- Pre-fetches job posting data (markdown + links) for all qualifying jobs
- Queues `jobAgent` jobs with pre-fetched data via `childQueueItems`
- Handles individual pre-fetch failures gracefully
- Tracks discovery statistics (jobs found, qualified, filtered out)
- Returns comprehensive `AgentResult` with discovery metrics
- **Supports optional pre-fetched data** with freshness checking (7-day TTL)

**Payload Schema:**
```typescript
{
  organizationId: number;
  careersUrl: string;  // URL of careers page
  companyName: string;
  preFetchedData?: {
    url: string;
    markdown: string;
    links: string[];
    pulledAt: number;
    freshTil: number;
  };
}
```

**Job Link Identification Rules:**
- Look for patterns like `/jobs/`, `/careers/`, `/positions/`, `/openings/`
- Extract job titles from URL slugs or link text
- Identify individual job listings on embedded boards (Lever, Greenhouse, Workday, etc.)
- Ignore generic pages (About Us, Benefits, Culture, Blog)
- Avoid duplicates
- Conservative: unsure links are filtered out

**Pre-Fetched Data TTL:** 7 days - jobBoardAgent re-scrapes if data is stale

### 16. Updated Organization Agent for Job Board Enqueuing

**File:** `apps/server/src/lib/ai/agents/major/organizationAgent.ts`

**Changes:**
- Added `childQueueItems` array to collect child tasks
- After creating organization and tagging, queues a `jobBoardAgent` job
- Passes `organizationId`, `careersUrl`, and `companyName` to jobBoardAgent
- Returns `childQueueItems` in `AgentResult` for the worker to process

**Workflow:**
```
organizationAgent
  └─> jobBoardAgent (finds job postings on careers page)
       └─> jobAgent × N (extracts job data for each posting)
```

### 17. Updated Agent Registry for Job Board Agent

**File:** `apps/server/src/lib/ai/agents/dictionary.ts`

**Changes:**
- Added `jobBoardAgent` to `agentNamesSchema`
- Registered agent in `getAgent()` switch statement

### 18. Created Job Board Agent Documentation

**File:** `apps/server/src/lib/ai/agents/major/jobBoardAgent.md`

Comprehensive documentation covering:
- Overview and workflow (5 steps: fetch, find, filter, pre-fetch, queue)
- Input schema (payload with `organizationId`, `careersUrl`, `companyName`, and optional `preFetchedData`)
- Output structure (`AgentResult` with discovery metrics)
- Job link identification rules and patterns
- Dependencies (Firecrawl, AI SDK, Gemini 2.5 Flash, Zod)
- Usage tracking (AI SDK usage from job link identification)
- Error handling with `AppError` codes
- Enqueuing example
- Pre-fetched data usage pattern
- Child task creation pattern
- Job filtering TODO comment for future filtering logic
- Registration in agent dictionary
- Example execution log
- Workflow integration (bridge between organizationAgent and jobAgent)
- Related files

## Key Technical Decisions

1. **Usage Field:** Changed from object with custom counters to `unknown[]` array that accepts AI SDK usage objects
2. **Agent Function Signature:** `createNewSourceFromMarkdown` now takes a mutable `usage` array parameter
3. **Type Safety:** `usage` typed as `unknown[]` since different AI models may return different usage structures

## File Structure

```
apps/server/
├── src/
│   ├── db/
│   │   └── functions/
│   │       ├── queues/index.ts      # getNextQueuedItem, updateStatus, addToQueue (with types)
│   │       └── calls/index.ts       # createCall, updateCall (with types)
│   ├── lib/ai/
│   │   ├── agents/
│   │   │   ├── helpers/
│   │   │   │   └── types.ts         # AgentHelpers, AgentResult interfaces
│   │   │   ├── dictionary.ts        # getAgent() with AgentEntry typing
│   │   │   ├── jobTaggingAgent.ts    # Job tagging agent
│   │   │   └── major/
│   │   │       ├── sourceAgent.ts           # Source agent implementation (updated)
│   │   │       ├── sourceAgent.md           # Documentation
│   │   │       ├── organizationAgent.ts      # Organization agent implementation (updated)
│   │   │       ├── organizationAgent.md      # Documentation
│   │   │       ├── portfolioLinksAgent.ts    # Portfolio links agent implementation
│   │   │       ├── portfolioLinksAgent.md    # Documentation
│   │   │       ├── jobAgent.ts              # Job agent implementation
│   │   │       ├── jobAgent.md              # Documentation
│   │   │       ├── jobBoardAgent.ts         # Job board agent implementation
│   │   │       └── jobBoardAgent.md         # Documentation
│   │   └── tools/db/
│   │       └── jobs.ts              # AI tool for job queries
│   └── workers/
│       ├── llmCallWorker.ts         # Worker implementation
│       └── llmCallWorker.md         # Worker documentation
└── tests/
    └── llmCallWorker.test.ts        # Tests (broken, not important right now)
packages/db/
└── src/
    └── schema/
        └── llm/
            ├── queues.ts            # llm-queues table
            └── calls.ts             # llm-calls table (usage column is jsonb array)
```

## Database Schema

### `llm-queues`
- `id` (serial, PK)
- `payload` (jsonb)
- `agent` (text)
- `status` (text): 'queued', 'in_progress', 'done', 'failed'
- `retryCount` (integer)
- `maxRetries` (integer)
- `createdAt`, `updatedAt` (timestamp)

### `llm-calls`
- `id` (serial, PK)
- `payload` (jsonb)
- `queueId` (integer, FK to llm-queues)
- `agent` (text)
- `usage` (jsonb, array, default []) ← This holds AI SDK usage objects
- `result` (jsonb, array, default [])
- `logs` (jsonb, array, default [])
- `errors` (jsonb, array, default [])
- `createdAt`, `updatedAt` (timestamp)

## Current State

- **LLM Agent System:** Fully functional with polling worker, registry, and multiple agents
- **Source Agent:** Correctly implemented with proper token usage tracking and child task enqueuing
- **Portfolio Links Agent:** Filters portfolio links for Canadian companies and pre-fetches data
- **Organization Agent:** Extracts organization data, supports optional pre-fetched data with freshness checks, enqueues jobBoardAgent
- **Job Board Agent:** Discovers job postings on careers pages, filters links, pre-fetches job data, queues jobAgent tasks
- **Job Agent:** Extracts job data, connects to organization, creates cache, and tags job
- **Agent Workflow:** sourceAgent → portfolioLinksAgent → organizationAgent → jobBoardAgent → jobAgent (full cascade from VC to jobs)
- **Tests:** Broken, not priority
- **Documentation:** Complete for worker and all agents
- **Import Paths:** Fixed `@/functions/*` → `@/db/functions/*` across codebase

## Next Steps (if continuing)

1. Consider adding more detailed typing for AI SDK usage objects if/when production models are decided
2. Fix tests when they become important
3. Add job filtering logic to jobBoardAgent (Canadian jobs only, remote-only, etc.) if needed
4. Add pagination handling to jobBoardAgent for careers pages with multiple pages of jobs
